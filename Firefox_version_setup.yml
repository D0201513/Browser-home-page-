---
- name: Enforce Firefox 117 permanently and auto-revert on change
  hosts: windows
  gather_facts: yes
  vars:
    firefox_version: "117.0"
    firefox_download_url: "https://archive.mozilla.org/pub/firefox/releases/117.0/win64/en-US/Firefox%20Setup%20117.0.exe"
    firefox_install_dir: "C:\\Program Files\\Mozilla Firefox"
    temp_dir: "C:\\temp"
    check_script_path: "C:\\ProgramData\\CheckFirefox.ps1"

  tasks:
    - name: Create temp and policy folders
      win_file:
        path: "{{ item }}"
        state: directory
      loop:
        - "{{ temp_dir }}"
        - "{{ firefox_install_dir }}\\distribution"

    - name: Download Firefox 117 installer
      win_get_url:
        url: "{{ firefox_download_url }}"
        dest: "{{ temp_dir }}\\Firefox_Setup_117.0.exe"

    - name: Install Firefox 117 silently
      win_package:
        path: "{{ temp_dir }}\\Firefox_Setup_117.0.exe"
        arguments: "/S /InstallDirectoryPath=\"{{ firefox_install_dir }}\""
        state: present
        wait_for_children: yes

    - name: Create Firefox policies.json to lock updates
      win_copy:
        dest: "{{ firefox_install_dir }}\\distribution\\policies.json"
        content: |
          {
            "policies": {
              "DisableAppUpdate": true
            }
          }

    - name: Create registry key to disable updates
      win_regedit:
        path: HKLM:\SOFTWARE\Policies\Mozilla\Firefox
        name: DisableAppUpdate
        data: 1
        type: dword

    - name: Add PowerShell check script to auto-revert Firefox version
      win_copy:
        dest: "{{ check_script_path }}"
        content: |
          $installed = (Get-ItemProperty "C:\\Program Files\\Mozilla Firefox\\firefox.exe").VersionInfo.ProductVersion
          if ($installed -notlike "117.0*") {
            Start-Process "C:\\Program Files\\Mozilla Firefox\\uninstall\\helper.exe" -ArgumentList "/S" -Wait
            Start-Sleep -Seconds 5
            Start-Process "{{ temp_dir }}\\Firefox_Setup_117.0.exe" -ArgumentList "/S /InstallDirectoryPath='{{ firefox_install_dir }}'" -Wait
          }

    - name: Schedule task to check Firefox version at every boot
      win_scheduled_task:
        name: "CheckFirefoxVersion"
        description: "Reverts Firefox to 117 if tampered"
        actions:
          - path: powershell.exe
            arguments: "-ExecutionPolicy Bypass -File {{ check_script_path }}"
        triggers:
          - type: boot
        username: "SYSTEM"
        run_level: highest
        state: present
        enabled: yes

    - name: Remove Firefox installer to clean up
      win_file:
        path: "{{ temp_dir }}\\Firefox_Setup_117.0.exe"
        state: absent
