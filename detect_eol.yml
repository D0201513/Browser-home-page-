---
- name: Detect Linux OS End of Life (EOL) Status
  hosts: Tirumangalam
  gather_facts: yes
  become: false
  vars:
    # Example EOL lookup table (update as needed)
    ubuntu_eol_dates:
      trusty: "2019-04-30"
      xenial: "2021-04-30"
      bionic: "2023-04-30"
      focal: "2025-04-30"
      jammy: "2027-04-30"
      noble: "2029-04-30"
    mint_eol_dates:
      uma: "2025-07-31"
      una: "2023-07-31"
      xia: "Unknown"  # Example; update as needed

  tasks:

    - name: Detect OS details
      set_fact:
        distro: "{{ ansible_distribution }}"
        version: "{{ ansible_distribution_version }}"
        codename: "{{ ansible_lsb.codename | default('Unknown') }}"

    - name: Determine EOL date
      set_fact:
        eol_date: >-
          {% if distro == 'Ubuntu' %}
          {{ ubuntu_eol_dates.get(codename, 'Unknown') }}
          {% elif distro == 'LinuxMint' %}
          {{ mint_eol_dates.get(codename, 'Unknown') }}
          {% else %}
          Unknown
          {% endif %}
        eol_status: >-
          {% if eol_date == 'Unknown' %}
          Unknown
          {% elif (ansible_date_time.date | to_datetime('%Y-%m-%d')) > (eol_date | to_datetime('%Y-%m-%d')) %}
          EOL - Upgrade Required!
          {% else %}
          Supported
          {% endif %}

    - name: Save EOL status to hostvars
      set_fact:
        eol_summary:
          os: "{{ distro }} {{ version }}"
          codename: "{{ codename }}"
          eol_date: "{{ eol_date }}"
          status: "{{ eol_status }}"

    - name: Debug per-host EOL status
      debug:
        msg: "EOL Status: {{ eol_status }}"

- name: Consolidate Linux EOL report and send email
  hosts: localhost
  gather_facts: no
  vars:
    notification_recipients: "aravind_slcs_intern2@aravind.org,karthikeyan.sudhakar@aravind.org"

  tasks:
    - name: Build consolidated EOL report
      run_once: true
      set_fact:
        consolidated_report: |
          | Hostname/IP | OS | Codename | EOL Date | Status |
          |-------------|----|---------|---------|--------|
          {% for host in groups['linux_servers'] %}
          | {{ host }} | {{ hostvars[host].eol_summary.os | default('Unknown') }} | {{ hostvars[host].eol_summary.codename | default('Unknown') }} | {{ hostvars[host].eol_summary.eol_date | default('Unknown') }} | {{ hostvars[host].eol_summary.status | default('‚ö†Ô∏è Unreachable') }} |
          {% endfor %}

    - name: Print consolidated EOL report
      debug:
        msg: "{{ consolidated_report }}"

    - name: Send consolidated EOL notification email
      community.general.mail:
        host: smtp.gmail.com
        port: 587
        secure: starttls
        username: "{{ lookup('env', 'EMAIL_USER') }}"
        password: "{{ lookup('env', 'EMAIL_PASSWORD') }}"
        to: "{{ notification_recipients }}"
        from: "{{ lookup('env', 'EMAIL_USER') }}"
        subject: "üì¢ Linux EOL Status Report"
        body: |
          Hello Team,

          The Linux End-of-Life (EOL) detection has been completed for the server group **linux_servers**.

          {{ consolidated_report }}

          Regards,
          üîß Ansible Automation System
